// ========== [START: ASCII ANIMATION] ========== //
document.addEventListener('DOMContentLoaded', function() {
  const asciiContent = `
yes!no!\/oys!mo!/ysa\
yes!no!\/oys!mo!/ysa\
yes!no!\/oys!mo!/ysa\
[abcXZ:. -+. abcXYZ:.-+. acXY:.+aXbY]
[abcXZ:. -+. abcXYZ:.-+. acXY:.+aXbY]
;;.;;.;;.;;.;;.;;.;;.;;.;;.;;.;WELCOME.;.;.;;.;;.;;.;;.;;.;;.;;.;;.;;
;;.;;.;;.;;.;;.;;.;;.;;.;;.;;.;WELCOME.;.;.;;.;;.;;.;;.;;.;;.;;.;;.;;
;;.;;.;;.;;.;;.;;.;;.;;.;;.;;.;WELCOME.;.;.;;.;;.;;.;;.;;.;;.;;.;;.;;
 [{({,.!;?i![](){}.,.!;?i![]({., 
[{({,.!;?i![](){}.,.!;?i![]({.,
[{({,.!;?i![](){}.,.!;?i![]({.,
[{({,.!;?i![](){}.,.!;?i![]({.,
xxxxxxxxxxxxxxxxx÷÷÷÷÷÷-------÷÷÷÷÷xxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxx÷÷÷÷÷÷-------÷÷÷÷÷xxxxxxxxxxxxxxxxxx
_________DAY 1_________
_____Fufu Clan___Fufu Clan___Fufu Clan___
___SUB___SUB___SUB___SUB___SUB___SUB_____
_____Re:NAN___Re:NAN___Re:NAN___Re:NAN___
___MADMAX___MADMAX___MADMAX___MADMAX_____
The Skit___The Skit___The Skit___The Skit
___COLORCODE___COLORCODE___COLORCODE_____
Niskala___Niskala___Niskala___Niskala___ 
vvvvvvvvv______vvvvvvvvv______vvvvvvvv
Fufu Clan;;.;;.;;.;;.;;.;;.;;.;;.;;.;;.;;.;;.;;.;;.;.;.;;.;;.;;.;;.;;.;;
.;.;;.;;.;<\%  SUB-\*%   <+>-\*%   <+>-\*%)  <+>-\*%)  <+>-\*%);;.;;.;;.;;.
.;.;.;;.;;.;<\%  <+>-\*%   Re:NAN   <+>-\*%)  <+>-\*%)  <+>-\*%);;.;;.;;.;;.
.;;.;;.;;.;;.;;.;;.;;.;;.;;.;;.;;.MADMAX;.;.;;.;;.;;.;;.;;.;;.;;.;;.;;.;
;;.;;.;;.;;.;;.;;.;;.;;.;;.;;.;;.;;.;;.;;.The Skit.;.;;.;;.;;.;;.;;.;;
.;.;;.;;.;<\%  <+>-\*%   <+>-\*% COLORCODE  <+>-\*%)  <+>-\*%);;.;;.;;.;;.
.;.;.;;.;;.;<\%  <+>-\*%   <+>-\*%   <+>-\*%)  <+>-\*%)  <+>-\*%);;.;;.;;.;;.
.;;.;;.;;.;;.;;.;;.;;.;;.;;.;;.;;.;;.;;.;.;;.;;.;;.;;.;Niskala;.;;.;;.;
V____Fufu Clan____VVVVVVVVVVVVVV_________V
V________VVVVVVVVVVVVVV______Fufu Clan___V
V____Fufu Clan____VVVVVVVVVVVVVV_________V
V________VVVVVVVVVVVVVV______Fufu Clan___V
SUBXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
XXXSUBXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
XXXXXXSUBXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
XXXXXXXXXSUBXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:Re:NAN
.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;Re:NAN.;:
.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;Re:NAN:;.;:
.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;Re:NAN.;:;.;:
___MADMAX___7777*:.-+888888888*/.-+999999999/.-+000
7777*:.-+888888888*/.-+999999999/.-+000___MADMAX___
___MADMAX___7777*:.-+888888888*/.-+999999999/.-+000
7777*:.-+888888888*/.-+999999999/.-+000___MADMAX___
!y3s\/n0!\/y3s!n0!\/y3s!n0!\/y3s!n0!\/y3s!n0!\___The Skit___
___The Skit___!y3s\/n0!\/y3s!n0!\/y3s!n0!\/y3s!n0!\/y3s!n0!\
!y3s\/n0!\/y3s!n0!\/y3s!n0!\/y3s!n0!\/y3s!n0!\___The Skit___
___The Skit___!y3s\/n0!\/y3s!n0!\/y3s!n0!\/y3s!n0!\/y3s!n0!\
*******:::::::*******:::::::*******:::::::COLORCODE
:::::::*******:::::::*******:::::::COLORCODE*******
*******:::::::*******:::::::COLORCODE*******:::::::
:::::::*******:::::::COLORCODE*******:::::::*******
VVVvvvvVVVVV_________VVVVVVV_______VVVV[Niskala]
VVVVVVVvvvvVVVVV_________VVVVVVV_______[Niskala]
vvvvVVVVVVVvvvvVVVVV_________VVVVVVV___[Niskala]
VVVvvvvVVVVV_________VVVVVVV_______VVVV[Niskala]
___________DAY 2____________
___Splitz___Splitz___Splitz
Reruntuh___Reruntuh___Reruntuh
___YoRi___YoRi___YoRi___YoRi
Tripov___Tripov___Tripov___
___Harum Manis___Harum Manis
_____Twenty Nine Teens_____
________White Chorus_______
vvvvvvvvvv______vvvvvvvvvv______vvvvv
!ys■o\/yes!no!\/yes!no!\/___Splitz___■o!\/ys■\!ys■o\/yes!no!\/
!ys■o\/yes!no!\/yes!no!\/yes!no!\/ys!■o!\/ys■\!y___Reruntuh___
___YoRi___!ys■o\/yes!no!\/yes!no!\/yes!no!\/ys!■o!\/ys■\!ys■o\
!ys■o\/yes!no!\/yes!no!\/yes!no!\/ys!■o!\/ys■\!ys■___Tripov___
___Tripov___!ys■o\/yes!no!\/yes!no!\/yes!no!\/ys!■o!\/ys■\!ys■
!ys■o\/yes!no!\/yes!no!\/yes!no!\/ys!■o!\/ys■___Harum Manis___
_____Twenty Nine Teens_____!ys■o\/yes!no!\/yes!no!\/yes!no!\/y
!ys■o\/yes!no!\/yes!no!\/yes!no!\/y________White Chorus_______
SplitzXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
XXXSplitzXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
XXXXXXSplitzXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
XXXXXXXXXSplitzXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:Reruntuh
.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;Reruntuh.;:
.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;Reruntuh:;.;:
.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;Reruntuh.;:;.;:
___YoRi___7777*:.-+888888888*/.-+999999999/.-+000
7777*:.-+888888888*/.-+999999999/.-+000___YoRi___
___YoRi___7777*:.-+888888888*/.-+999999999/.-+000
7777*:.-+888888888*/.-+999999999/.-+000___YoRi___
!y3s\/n0!\/y3s!n0!\/y3s!n0!\/y3s!n0!\/y3s!n0!\___Tripov___
___Tripov___!y3s\/n0!\/y3s!n0!\/y3s!n0!\/y3s!n0!\/y3s!n0!\
!y3s\/n0!\/y3s!n0!\/y3s!n0!\/y3s!n0!\/y3s!n0!\___Tripov___
___Tripov___!y3s\/n0!\/y3s!n0!\/y3s!n0!\/y3s!n0!\/y3s!n0!\
*******:::::::*******:::::::*******:::::::Harum Manis
:::::::*******:::::::*******:::::::Harum Manis*******
*******:::::::*******:::::::Harum Manis*******:::::::
:::::::*******:::::::Harum Manis*******:::::::*******
VVVvvvvVVVVV_________VVVVVVV_______VVVV[Twenty Nine Teens]
VVVVVVVvvvvVVVVV_________VVVVVVV_______[Twenty Nine Teens]
vvvvVVVVVVVvvvvVVVVV_________VVVVVVV___[Twenty Nine Teens]
VVVvvvvVVVVV_________VVVVVVV_______VVVV[Twenty Nine Teens]
.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:White Chorus
.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;White Chorus.;:
.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;White Chorus:;.;:
.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;White Chorus.;:;.;:
_____________DAY 3____________
GALLYGLITCH___GALLYGLITCH___GALLYGLITCH___
___XANDEGA___XANDEGA___XANDEGA___XANDEGA
AntiNRML___AntiNRML___AntiNRML___AntiNRML
___PORIS___PORIS___PORIS___PORIS
___Shakaboyd___Shakaboyd___Shakaboyd____
___Xiblinx___Xiblinx___Xiblinx___Xiblinx
Sun Mejik___Sun Mejik___Sun Mejik____
___Toxicdev!___Toxicdev!___Toxicdev!____
__________Give it To Me Harder__________
_____vvvvvvv___vvvvvvv______vvvvvvvv_
___Gallyglitch___;;.;;.;;.;;.;;.;;.;;.;;.;;.;;.;;.;;.;;.;;.;;.;.;.;;.;;.;;.
/////////////.;.___Xandega___;;.;;.;;.;;.;;.;;.;;.;;.;;.;;.;;.;;.;;.;;.;;./
;;.;;.;;.;;.;;.;;.;;.;;.;;.;;.___Antinrml___.;.;.;;.;;.;;.;;.;;.;;.;;.;;.;;
;;.;;.;;.;;.;;.;;.;;.;;.;;.;;.;;.;;.;;.;;.;;___Xiblinx___.;;.;;.;;.;;.;;.;;
;;.;;.;;.;;.;;.;;.;;.;;.;;.;;.;;.;;.;;.;;.;;.;.;.;;.;;.;;.___Feel Koplo___;
;;.;;.;;.;;.;;.;;.;;.;;.;;.;;.;;.;;.;;.;;.___Toxicdev!___.;;.;;.;;.;;.;;.;;
;;.;;.;;.;;.;;.____Give it To Me Harder_____;;.;.;.;;.;;.;;.;;.;;.;;.;;.;;;
[abcXZ:. -+. abcXYZ:.-+. acXY:.+aXbY][abcXZ:. -+. abcXYZ:.-+. acXY:.+aXbY]
[abcXZ:. -+. abcXYZ:.-+. acXY:.+aXbY][abcXZ:. -+. abcXYZ:.-+. acXY:.+aXbY]
[abcXZ:. -+. abcXYZ:.-+. acXY:.+aXbY][abcXZ:. -+. abcXYZ:.-+. acXY:.+aXbY]
.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:Gallyglitch
.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;Gallyglitch.;:
.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;Gallyglitch:;.;:
.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;Gallyglitch.;:;.;:
___Xandega___7777*:.-+888888888*/.-+999999999/.-+000
7777*:.-+888888888*/.-+999999999/.-+000___Xandega___
___Xandega___7777*:.-+888888888*/.-+999999999/.-+000
7777*:.-+888888888*/.-+999999999/.-+000___Xandega___
!y3s\/n0!\/y3s!n0!\/y3s!n0!\/y3s!n0!\/y3s!n0!\___Antinrml___
___Antinrml___!y3s\/n0!\/y3s!n0!\/y3s!n0!\/y3s!n0!\/y3s!n0!\
!y3s\/n0!\/y3s!n0!\/y3s!n0!\/y3s!n0!\/y3s!n0!\___Antinrml___
___Antinrml___!y3s\/n0!\/y3s!n0!\/y3s!n0!\/y3s!n0!\/y3s!n0!\
*******:::::::*******:::::::*******:::::::Xiblinx
:::::::*******:::::::*******:::::::Xiblinx*******
*******:::::::*******:::::::Xiblinx*******:::::::
:::::::*******:::::::Xiblinx*******:::::::*******
VVVvvvvVVVVV_________VVVVVVV_______VVVV[Sun Mejik]
VVVVVVVvvvvVVVVV_________VVVVVVV_______[Sun Mejik]
vvvvVVVVVVVvvvvVVVVV_________VVVVVVV___[Sun Mejik]
VVVvvvvVVVVV_________VVVVVVV_______VVVV[Sun Mejik]
.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:Toxicdev!
.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;Toxicdev!.;:
.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;Toxicdev!:;.;:
.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;.;:;Toxicdev!.;:;.;:
*******:::::::*******:::::::*******:::::::Give it To Me Harder
:::::::*******:::::::*******:::::::Give it To Me Harder*******
*******:::::::*******:::::::Give it To Me Harder*******:::::::
:::::::*******:::::::Give it To Me Harder*******:::::::*******
 ___Poris___[{({,.!;?i![](){}.,.!;?i![]({., 
[{({___Poris___,.!;?i![](){}.,.!;?i![]({.,
[{({,.!;?___Poris___i![](){}.,.!;?i![]({.,
[{({,.!;?i![___Poris___](){}.,.!;?i![]({.,
<<--==++*___Shakaboyd___*++==-->><<--==++**++==-->>
<<--==++**++==-->><<--==++*___Shakaboyd___*++==-->>
<<--==++*___Shakaboyd___*++==-->><<--==++**++==-->>
<<--==++**++==-->><<--==++*___Shakaboyd___*++==-->>
      `.trim();

const asciiElement = document.getElementById('asciiContent');
  asciiElement.textContent = asciiContent;
  
  let animationId;
  let position = -asciiElement.scrollHeight; // Mulai dari atas (di luar viewport)
  const speed = 0.7; // Kecepatan sedikit diperlambat
  
  // Tunggu hingga elemen di-render sepenuhnya
  setTimeout(() => {
    // Fungsi animasi ASCII
    function animateAscii() {
      position += speed;
      
      // Jika konten sudah melewati bawah layar, reset ke atas
      if (position > window.innerHeight) {
        position = -asciiElement.scrollHeight;
      }
      
      asciiElement.style.transform = `translateY(${position}px)`;
      animationId = requestAnimationFrame(animateAscii);
    }
    
    // Mulai animasi ASCII
    animateAscii();
    
    // Hentikan animasi saat tab tidak aktif untuk menghemat resources
    document.addEventListener('visibilitychange', function() {
      if (document.hidden) {
        cancelAnimationFrame(animationId);
      } else {
        animateAscii();
      }
    });
  }, 100);
});

// ========== [START: BACKGROUND MUSIC SETUP] ========== //
const bgMusic = document.getElementById('bgMusic');

// Fungsi untuk memutar audio setelah interaksi pengguna
function enableAudio() {
  document.removeEventListener('click', enableAudio);
  document.removeEventListener('keydown', enableAudio);
  document.removeEventListener('touchstart', enableAudio);
  
  bgMusic.volume = 0.5; // Volume 50%
  const playPromise = bgMusic.play();
  
  if (playPromise !== undefined) {
    playPromise.catch(error => {
      console.log('Autoplay prevented:', error);
    });
  }
}

// Aktifkan audio saat pengguna pertama kali berinteraksi
document.addEventListener('click', enableAudio, { once: true });
document.addEventListener('keydown', enableAudio, { once: true });
document.addEventListener('touchstart', enableAudio, { once: true });

const isTouchDevice = window.matchMedia("(pointer: coarse)").matches;

// Initialize elements
const strukContainer = document.getElementById('strukContainer');
const scrollContainer = document.getElementById('scrollContainer');
const cursor = document.getElementById('cursor');
const cursorFollower = document.getElementById('cursorFollower');
const cursorText = document.getElementById('cursorText');
const infoModal = document.getElementById('infoModal');
const closeModal = document.getElementById('closeModal');
const zoomInBtn = document.getElementById('zoomIn');
const zoomOutBtn = document.getElementById('zoomOut');
const previewModal = document.getElementById('previewModal');
const previewImage = document.getElementById('previewImage');
const closePreview = document.getElementById('closePreview');
const shareButton = document.getElementById('shareButton');
const infoBtn = document.getElementById('infoBtn');
const moodBtn = document.getElementById('moodBtn');
const dropMomentBtn = document.getElementById('dropMomentBtn');

// Search elements
const searchModal = document.getElementById('searchModal');
const searchInput = document.getElementById('searchInput');
const searchResults = document.getElementById('searchResults');
const closeSearch = document.getElementById('closeSearch');
const searchButton = document.getElementById('searchButton');

// Mood settings
const moods = ['default', 'black', 'yellow', 'purple'];
const moodLabels = ['DEFAULT', 'BLACK', 'YELLOW', 'PURPLE'];
let currentMoodIndex = 0;

// Initialize mood
document.body.setAttribute('data-mood', moods[currentMoodIndex]);
moodBtn.textContent = `MOOD (${moodLabels[currentMoodIndex]})`;

// Receipt data with names
const strukFiles = [
  { name: "Go Tiket Pestapora", file: 'Struk 1_Trial.png' },
  { name: "Yukmaju", file: 'Struk 2_Trial.png' },
  { name: "reichansepta", file: 'Struk 3_Trial.png' },
  { name: "Noname", file: 'Struk 4.png' },
  { name: "Lebah Qol", file: 'Struk 5.png' },
  { name: "The Skit", file: 'The Skit 1.png' },
  { name: "Ze.Grave", file: 'Ze.Grave_STRUK.png' },
  { name: "beth__", file: 'beth__ STRUK.png' },
  { name: "dillah", file: 'dillah_STRUK.png' },
  { name: "duck", file: 'duck_STRUK.png' },
  { name: "gunawansaputra21", file: 'gunawansaputra21_STRUK.png' },
  { name: "hankrayyy", file: 'hankrayyy_STRUK.png' },
  { name: "lawliet15", file: 'lawliet15_STRUK.png' },
  { name: "mykey", file: 'mykey_STRUK.png' },
  { name: "ponarikeren", file: 'ponarikeren_STRUK.png' },
  { name: "reichansepta", file: 'reichansepta_STRUK.png' },
  { name: "TOXICDEV", file: 'TOXICDEV 1.png' },
  { name: "anakbaik", file: 'anakbaik_STRUK.png' },
  { name: "WhiteChorus", file: 'WC_STRUK.png' },
  { name: "Twentynineteens", file: 'TNT 1.png' },
  { name: "THE SKIT", file: 'THE SKIT 2.png' },
  { name: "UCUP", file: 'UCUP_STRUK.png' },
  { name: "HARUM MANIS", file: 'HARUM MANIS 1.png' },
  { name: "FANS YORI", file: 'FANS YORI_STRUK.png' },
  { name: "UCUP", file: 'UCUP_STRUK.png' },
  { name: "DODOL GARUT", file: 'DODOL GARUT_STRUK.png' },
  { name: "COLORCODE", file: 'COLORCODE 1.png' },
  { name: "ANTINRML", file: 'ANTINRML 1.png' },
  
];

// Generate struks in a grid
const strukWidth = 150;
const gap = 20;
const gridSize = 5000;
const cols = Math.ceil(gridSize / (strukWidth + gap));
const rows = Math.ceil(gridSize / (strukWidth + gap));

// Store all struk elements and their initial positions
const struks = [];
let isHovering = false; // Track hover state for cursor

// Function to create struk elements
function createStruk(i, j) {
  const struk = document.createElement('img');
  struk.className = 'struk';
  const randomStruk = strukFiles[Math.floor(Math.random() * strukFiles.length)];
  struk.src = randomStruk.file;
  struk.alt = randomStruk.name;
  struk.loading = 'lazy';
  const randomRotation = Math.random() * 20 - 10;
  
  // Store initial position and rotation
  const strukObj = {
    element: struk,
    baseX: j * (strukWidth + gap),
    baseY: i * (strukWidth + gap),
    rotation: randomRotation,
    src: randomStruk.file,
    name: randomStruk.name
  };
  
  struks.push(strukObj);
  strukContainer.appendChild(struk);
  
  return strukObj;
}

// Create struks in batches for better performance
function createStruksBatch() {
  const batchSize = 50;
  let i = 0, j = 0;
  
  function processBatch() {
    const endI = Math.min(i + batchSize, rows);
    const endJ = Math.min(j + batchSize, cols);
    
    for (; i < endI; i++) {
      for (; j < endJ; j++) {
        createStruk(i, j);
      }
      j = 0;
    }
    
    if (i < rows) {
      requestAnimationFrame(processBatch);
    } else {
      // Center the scroll after all struks are loaded
      scrollContainer.scrollTo(gridSize/2 - window.innerWidth/2, gridSize/2 - window.innerHeight/2);
    }
  }
  
  processBatch();
}

createStruksBatch();

// Zoom functionality
let scale = 1;
const minScale = 0.3;
const maxScale = 2;
const scaleStep = 0.2;

function updateZoom() {
  strukContainer.style.transform = `scale(${scale})`;
}

zoomInBtn.addEventListener('click', () => {
  scale = Math.min(scale + scaleStep, maxScale);
  updateZoom();
});

zoomOutBtn.addEventListener('click', () => {
  scale = Math.max(scale - scaleStep, minScale);
  updateZoom();
});

// Handle mouse wheel for zoom
scrollContainer.addEventListener('wheel', (e) => {
  if (e.ctrlKey) {
    e.preventDefault();
    const delta = e.deltaY;
    if (delta < 0) {
      scale = Math.min(scale + scaleStep, maxScale);
    } else {
      scale = Math.max(scale - scaleStep, minScale);
    }
    updateZoom();
  }
}, { passive: false });

// Custom cursor movement (only for non-touch devices)
if (!isTouchDevice) {
  let mouseX = 0, mouseY = 0;
  let followerX = 0, followerY = 0;

  function animateCursor() {
    // Main cursor (small circle)
    cursor.style.left = mouseX + 'px';
    cursor.style.top = mouseY + 'px';
    
    // Follower cursor (larger circle with delay)
    followerX += (mouseX - followerX) * 0.2;
    followerY += (mouseY - followerY) * 0.2;
    cursorFollower.style.left = followerX + 'px';
    cursorFollower.style.top = followerY + 'px';
    
    // Cursor text position
    cursorText.style.left = mouseX + 'px';
    cursorText.style.top = mouseY + 'px';
    
    requestAnimationFrame(animateCursor);
  }

  animateCursor();

  // Track mouse position
  document.addEventListener('mousemove', function (e) {
    mouseX = e.clientX;
    mouseY = e.clientY;

    const scrollX = e.clientX + scrollContainer.scrollLeft;
    const scrollY = e.clientY + scrollContainer.scrollTop;
    
    let activeStruk = null;
    let minDistance = Infinity;

    // Find the closest struk to cursor
    struks.forEach(strukObj => {
      const struk = strukObj.element;
      const rect = struk.getBoundingClientRect();
      const centerX = rect.left + rect.width/2 + scrollContainer.scrollLeft;
      const centerY = rect.top + rect.height/2 + scrollContainer.scrollTop;
      const distance = Math.sqrt(
        Math.pow(scrollX - centerX, 2) + 
        Math.pow(scrollY - centerY, 2)
      );

      // Only activate if cursor is within 200px of struk center
      if (distance < 200) {
        if (distance < minDistance) {
          minDistance = distance;
          activeStruk = strukObj;
        }
      }
    });

    // Apply effects to all struks
    struks.forEach(strukObj => {
      const struk = strukObj.element;
      const rect = struk.getBoundingClientRect();
      const centerX = rect.left + rect.width/2;
      const centerY = rect.top + rect.height/2;
      const distance = Math.sqrt(
        Math.pow(e.clientX - centerX, 2) + 
        Math.pow(e.clientY - centerY, 2)
      );

      if (strukObj === activeStruk) {
        // For the closest struk - follow cursor and scale up
        const followAmount = 0.2;
        const targetX = strukObj.baseX + (e.clientX - centerX) * followAmount;
        const targetY = strukObj.baseY + (e.clientY - centerY) * followAmount;
        
        const scaleAmount = 1.5 - (distance / 200) * 0.5; // Scale up to 1.5x
        
        struk.style.transform = `
          translate(${targetX}px, ${targetY}px)
          rotate(${strukObj.rotation}deg)
          scale(${scaleAmount})
        `;
        struk.style.zIndex = '10';
        
        // Update cursor state
        cursor.classList.add('hover');
        cursorFollower.style.width = '30px';
        cursorFollower.style.height = '30px';
        cursorText.classList.add('active');
        isHovering = true;
      } else {
        // For other struks - return to original position
        struk.style.transform = `
          translate(${strukObj.baseX}px, ${strukObj.baseY}px)
          rotate(${strukObj.rotation}deg)
          scale(1)
        `;
        struk.style.zIndex = '0';
      }
    });

    // Reset cursor if not hovering over any struk
    if (!activeStruk && isHovering) {
      cursor.classList.remove('hover');
      cursorFollower.style.width = '10px';
      cursorFollower.style.height = '10px';
      cursorText.classList.remove('active');
      isHovering = false;
    }
  });

  document.addEventListener('mousedown', () => {
    cursor.classList.add('active');
    cursorFollower.style.width = '15px';
    cursorFollower.style.height = '15px';
  });
  
  document.addEventListener('mouseup', () => {
    cursor.classList.remove('active');
    cursorFollower.style.width = isHovering ? '30px' : '10px';
    cursorFollower.style.height = isHovering ? '30px' : '10px';
  });
  
  // Add cursor effects to modal elements (including dropMomentBtn)
  const modalInteractiveElements = [
    closeModal, zoomInBtn, zoomOutBtn, closePreview, shareButton,
    infoBtn, moodBtn, dropMomentBtn, closeSearch, searchButton
  ];
  
  modalInteractiveElements.forEach(el => {
    if (el) {
      el.addEventListener('mouseenter', () => {
        cursor.classList.add('hover');
        cursorFollower.style.width = '30px';
        cursorFollower.style.height = '30px';
        isHovering = true;
      });
      
      el.addEventListener('mouseleave', () => {
        cursor.classList.remove('hover');
        cursorFollower.style.width = '10px';
        cursorFollower.style.height = '10px';
        isHovering = false;
      });
    }
  });
}

// Click handler for struks to show preview
struks.forEach(strukObj => {
  strukObj.element.addEventListener('click', (e) => {
    e.preventDefault();
    previewImage.src = strukObj.src;
    previewModal.classList.add('active');
    document.body.style.overflow = 'hidden';
    
    // Force reflow to trigger animation
    void previewModal.offsetWidth;
  });
});

// Close preview modal
closePreview.addEventListener('click', () => {
  previewModal.classList.remove('active');
  setTimeout(() => {
    document.body.style.overflow = '';
  }, 500);
});

// Enhanced share functionality with receipt name
shareButton.addEventListener('click', () => {
  const strukObj = struks.find(s => s.src === previewImage.src);
  const strukName = strukObj?.name || "My Receipt";
  
  if (navigator.share) {
    navigator.share({
      title: `Alternative Stage: ${strukName}`,
      text: 'Check out my receipt from Alternative Stage',
      url: previewImage.src
    }).catch(err => {
      console.log('Error sharing:', err);
      fallbackShare(previewImage.src, strukName);
    });
  } else {
    fallbackShare(previewImage.src, strukName);
  }
});

function fallbackShare(imageSrc, name) {
  // Create a temporary link for download
  const link = document.createElement('a');
  link.href = imageSrc;
  link.download = `alternative-stage-${name.replace(/\s+/g, '-').toLowerCase()}.png`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  // Alert user about the download
  alert(`"${name}" has been downloaded. You can now share it from your gallery.`);
}

// Info button functionality
infoBtn.addEventListener('click', () => {
  infoModal.style.display = 'flex';
});

closeModal.addEventListener('click', () => {
  infoModal.style.display = 'none';
});

window.addEventListener('click', (e) => {
  if (e.target === infoModal) {
    infoModal.style.display = 'none';
  }
});

// Mood button functionality - single click cycle through moods
moodBtn.addEventListener('click', () => {
  // Cycle to next mood
  currentMoodIndex = (currentMoodIndex + 1) % moods.length;
  
  // Apply new mood
  document.body.setAttribute('data-mood', moods[currentMoodIndex]);
  
  // Update button text
  moodBtn.textContent = `MOOD (${moodLabels[currentMoodIndex]})`;
});

// ========== [START: SEARCH FUNCTIONALITY] ========== //
// Open search modal when clicking "Let's drop a micro moment"
dropMomentBtn.addEventListener('click', () => {
  searchModal.classList.add('active');
  document.body.style.overflow = 'hidden';
  searchInput.focus();
  searchReceipts(''); // Show all receipts initially
});

// Close search modal
closeSearch.addEventListener('click', () => {
  searchModal.classList.remove('active');
  document.body.style.overflow = '';
});

// Search function
function searchReceipts(query) {
  searchResults.innerHTML = '';
  const normalizedQuery = query.toLowerCase().trim();
  
  if (!normalizedQuery) {
    // Show all receipts if search is empty
    strukFiles.forEach((struk, index) => {
      addReceiptToSearchResults(struk, index);
    });
    return;
  }

  const filtered = strukFiles.filter(struk => 
    struk.name.toLowerCase().includes(normalizedQuery)
  );

  if (filtered.length === 0) {
    searchResults.innerHTML = '<p class="no-results">No receipts found. Try a different search term.</p>';
  } else {
    filtered.forEach((struk, index) => {
      addReceiptToSearchResults(struk, index);
    });
  }
}

function addReceiptToSearchResults(struk, index) {
  const receiptItem = document.createElement('div');
  receiptItem.className = 'receipt-item';
  receiptItem.innerHTML = `
    <span class="receipt-name">${struk.name}</span>
    <span class="receipt-view">VIEW</span>
  `;
  receiptItem.addEventListener('click', () => {
    highlightReceipt(struk.file);
    searchModal.classList.remove('active');
    document.body.style.overflow = '';
  });
  searchResults.appendChild(receiptItem);
}

function highlightReceipt(filePath) {
  // Find the struk in the grid
  const strukObj = struks.find(s => s.src === filePath);
  if (strukObj) {
    // Scroll to the struk
    scrollContainer.scrollTo({
      left: strukObj.baseX - window.innerWidth/2 + strukWidth/2,
      top: strukObj.baseY - window.innerHeight/2 + strukWidth/2,
      behavior: 'smooth'
    });

    // Add highlight effect
    strukObj.element.classList.add('highlight');
    setTimeout(() => {
      strukObj.element.classList.remove('highlight');
    }, 2000);
    
    // Show preview
    previewImage.src = strukObj.src;
    previewModal.classList.add('active');
  }
}

// Search when typing
searchInput.addEventListener('input', (e) => {
  searchReceipts(e.target.value);
});

// Search when button clicked
searchButton.addEventListener('click', () => {
  searchReceipts(searchInput.value);
});

// Search when pressing Enter
searchInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    searchReceipts(searchInput.value);
  }
});
